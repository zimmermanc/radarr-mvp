# Gateway API - Modern alternative to Ingress
# Provides advanced traffic management, security, and observability
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: radarr-mvp-gateway
  namespace: radarr-mvp
  labels:
    app.kubernetes.io/name: radarr-mvp
    app.kubernetes.io/component: gateway
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  gatewayClassName: istio
  listeners:
  - name: https
    hostname: radarr.yourdomain.com
    port: 443
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - name: radarr-mvp-tls
        kind: Secret
    allowedRoutes:
      namespaces:
        from: Same
  - name: http
    hostname: radarr.yourdomain.com
    port: 80
    protocol: HTTP
    allowedRoutes:
      namespaces:
        from: Same
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: radarr-mvp-route
  namespace: radarr-mvp
  labels:
    app.kubernetes.io/name: radarr-mvp
    app.kubernetes.io/component: routing
spec:
  parentRefs:
  - name: radarr-mvp-gateway
  hostnames:
  - radarr.yourdomain.com
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Forwarded-Proto
          value: https
        - name: X-Real-IP
          value: "%{REMOTE_ADDR}"
    - type: ResponseHeaderModifier
      responseHeaderModifier:
        add:
        - name: X-Frame-Options
          value: SAMEORIGIN
        - name: X-Content-Type-Options
          value: nosniff
        - name: X-XSS-Protection
          value: "1; mode=block"
        - name: Strict-Transport-Security
          value: max-age=31536000; includeSubDomains
    backendRefs:
    - name: radarr-mvp-service
      port: 7878
      weight: 100
  - matches:
    - path:
        type: Exact
        value: /metrics
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: Authorization
          value: "Basic ${METRICS_AUTH_TOKEN}"
    backendRefs:
    - name: radarr-mvp-service
      port: 7878
      weight: 100
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: ReferenceGrant
metadata:
  name: radarr-mvp-reference-grant
  namespace: radarr-mvp
  labels:
    app.kubernetes.io/name: radarr-mvp
    app.kubernetes.io/component: security
spec:
  from:
  - group: gateway.networking.k8s.io
    kind: Gateway
    namespace: istio-system
  to:
  - group: ""
    kind: Service
    name: radarr-mvp-service
---
# Rate limiting with Gateway API
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: BackendLBPolicy
metadata:
  name: radarr-mvp-lb-policy
  namespace: radarr-mvp
  labels:
    app.kubernetes.io/name: radarr-mvp
    app.kubernetes.io/component: loadbalancing
spec:
  targetRef:
    group: ""
    kind: Service
    name: radarr-mvp-service
  sessionPersistence:
    sessionName: radarr-session
    absoluteTimeout: 3600s
    idleTimeout: 300s
    type: Cookie
  healthChecking:
    unhealthyThreshold: 3
    healthyThreshold: 2
    interval: 10s
    timeout: 5s
    path: /health
    port: 7878
    protocol: HTTP